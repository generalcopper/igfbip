<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#1c6fe6" />

  <title>Content Studio | iLovePaghe</title>
  <meta name="robots" content="noindex,nofollow" />

  <style>
    :root{
      --bg:#f6f7f8;
      --card:#ffffff;
      --stroke:rgba(15,23,42,.10);
      --text:rgba(15,23,42,.92);
      --muted:rgba(15,23,42,.62);
      --accent:#1c6fe6;
      --accent-soft:rgba(28,111,230,.10);
      --shadow:0 16px 44px rgba(15,23,42,.06);
      --r-lg:22px;
      --r-md:16px;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bot: env(safe-area-inset-bottom, 0px);
      --focus:0 0 0 3px rgba(28,111,230,.18),0 0 0 6px rgba(28,111,230,.08);
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    html,body{
      margin:0;
      min-height:100%;
      font-family: ui-sans-serif,system-ui,"Segoe UI",Roboto,"Helvetica Neue",Helvetica,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
      letter-spacing:-0.01em;
      line-height:1.55;
    }
    :focus-visible{ outline:none; box-shadow:var(--focus); border-radius:12px; }

    .wrap{
      width:100%;
      max-width:1100px;
      margin:0 auto;
      padding:calc(20px + var(--safe-top)) clamp(16px,4vw,34px) calc(80px + var(--safe-bot));
      display:grid;
      gap:14px;
    }

    .top{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:var(--r-lg);
      box-shadow:var(--shadow);
      padding:14px 14px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px 12px;
      flex-wrap:wrap;
    }
    .title{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .title h1{
      margin:0;
      font-size:16px;
      font-weight:700;
      letter-spacing:-0.02em;
      white-space:nowrap;
    }
    .title p{
      margin:0;
      font-size:12px;
      font-weight:560;
      color:var(--muted);
      max-width:min(70ch, 90vw);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .mode{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .pill{
      border:1px solid rgba(15,23,42,.12);
      background:rgba(15,23,42,.03);
      border-radius:999px;
      padding:8px 12px;
      font-size:12px;
      font-weight:750;
      color:rgba(15,23,42,.70);
      cursor:pointer;
      user-select:none;
      transition:transform .16s cubic-bezier(.22,.61,.36,1), background .14s ease, border-color .14s ease;
      white-space:nowrap;
    }
    .pill:active{ transform:translateY(1px) scale(.99); }
    .pill.active{
      background:var(--accent-soft);
      border-color:rgba(28,111,230,.22);
      color:rgba(18,74,164,.94);
    }

    .actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
      flex:1 1 auto;
    }
    .btn{
      border:1px solid rgba(15,23,42,.14);
      background:#fff;
      border-radius:14px;
      padding:10px 12px;
      font-size:13px;
      font-weight:750;
      color:rgba(15,23,42,.90);
      cursor:pointer;
      user-select:none;
      min-height:40px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition:transform .16s cubic-bezier(.22,.61,.36,1), opacity .14s ease;
      white-space:nowrap;
    }
    .btn:active{ transform:translateY(1px) scale(.99); opacity:.92; }
    .btn.primary{
      background:var(--accent);
      border-color:var(--accent);
      color:#fff;
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

    .spinner{
      width:14px; height:14px;
      border-radius:999px;
      border:2px solid rgba(255,255,255,.45);
      border-top-color:#fff;
      display:none;
      animation:spin .9s linear infinite;
    }
    .btn:not(.primary) .spinner{
      border:2px solid rgba(15,23,42,.18);
      border-top-color:rgba(15,23,42,.62);
    }
    .btn.loading .spinner{ display:inline-block; }
    @keyframes spin{ to{ transform:rotate(360deg);} }

    .card{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:var(--r-lg);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(15,23,42,.06);
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:10px;
      flex-wrap:wrap;
    }
    .cardHead .h{
      font-size:14px;
      font-weight:750;
      margin:0;
    }
    .status{
      font-size:12px;
      font-weight:650;
      color:rgba(15,23,42,.58);
      padding:6px 10px;
      border:1px solid rgba(15,23,42,.10);
      background:rgba(15,23,42,.03);
      border-radius:999px;
      white-space:nowrap;
    }
    .status.good{ background:rgba(52,199,89,.12); border-color:rgba(52,199,89,.18); color:rgba(24,140,70,.92); }
    .status.warn{ background:rgba(255,159,10,.14); border-color:rgba(255,159,10,.18); color:rgba(155,96,0,.94); }

    .grid{
      display:grid;
      grid-template-columns:1fr;
      gap:14px;
      padding:14px;
    }
    @media (min-width: 920px){
      .grid{ grid-template-columns: .95fr 1.05fr; }
    }

    .field{ display:grid; gap:8px; }
    .label{
      font-size:12px;
      font-weight:750;
      color:rgba(15,23,42,.70);
    }
    .input, .textarea{
      width:100%;
      border:1px solid rgba(15,23,42,.12);
      border-radius:14px;
      background:#fff;
      padding:10px 12px;
      font-size:13px;
      font-weight:560;
      color:rgba(15,23,42,.86);
      outline:none;
    }
    .input::placeholder, .textarea::placeholder{ color:rgba(15,23,42,.45); }
    .input:focus, .textarea:focus{ border-color:rgba(28,111,230,.35); box-shadow:var(--focus); }
    .textarea{ min-height:120px; resize:vertical; }

    .note{
      font-size:12px;
      font-weight:560;
      color:rgba(15,23,42,.58);
    }

    .out{
      display:grid;
      gap:12px;
    }
    .block{
      border:1px solid rgba(15,23,42,.10);
      border-radius:18px;
      overflow:hidden;
      background:#fff;
    }
    .blockHead{
      padding:10px 12px;
      border-bottom:1px solid rgba(15,23,42,.06);
      background:rgba(15,23,42,.02);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .blockTitle{
      font-size:12px;
      font-weight:850;
      letter-spacing:.02em;
      color:rgba(15,23,42,.70);
      text-transform:uppercase;
    }
    .mini{
      font-size:12px;
      font-weight:750;
      border:1px solid rgba(15,23,42,.12);
      background:#fff;
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
      user-select:none;
      min-height:34px;
    }
    .mini:active{ transform:translateY(1px) scale(.99); opacity:.92; }
    .blockBody{ padding:10px 12px 12px; }
    .pre{
      white-space:pre-wrap;
      font-size:13px;
      font-weight:560;
      color:rgba(15,23,42,.82);
      line-height:1.5;
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      font-weight:560;
      color:rgba(15,23,42,.74);
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:rgba(15,23,42,.92);
      color:#fff;
      padding:10px 12px;
      border-radius:14px;
      font-size:13px;
      font-weight:650;
      opacity:0;
      pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(-2px);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top" role="banner" aria-label="Barra Content Studio">
      <div class="title">
        <h1>Content Studio</h1>
        <p id="subTitle">Generatore manuale â€¢ prende contesto da ilovepaghe.com</p>
      </div>

      <div class="mode" role="tablist" aria-label="ModalitÃ ">
        <button class="pill active" id="modePost" type="button" role="tab" aria-selected="true">General Post</button>
        <button class="pill" id="modeReel" type="button" role="tab" aria-selected="false">General Reel</button>
      </div>

      <div class="actions">
        <button class="btn primary" id="btnGenerate" type="button">
          <span class="spinner" aria-hidden="true"></span>
          <span>Genera</span>
        </button>
        <button class="btn" id="btnCopyAll" type="button">Copia tutto</button>
      </div>
    </div>

    <div class="card" aria-label="Editor">
      <div class="cardHead">
        <h2 class="h">Brief</h2>
        <span class="status warn" id="ctxStatus">Contesto: in caricamentoâ€¦</span>
      </div>

      <div class="grid">
        <div class="field">
          <div class="label">Idea / angolo (opzionale)</div>
          <textarea id="brief" class="textarea" placeholder="Esempi:&#10;â€¢ PerchÃ© inviare cedolini via email senza errori&#10;â€¢ Demo iLovePaghe: come funziona in 30 secondi&#10;â€¢ Caso reale: da caos a ordine con un processo pulito"></textarea>
          <div class="note">
            Se lasci vuoto, genero un contenuto generale basato sul sito.
          </div>
          <div class="note" id="hint" style="display:none;"></div>
        </div>

        <div class="out" id="outArea">
          <!-- OUTPUT blocks injected here -->
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script>
    (function(){
      "use strict";

      // ===== Config =====
      const SITE_BASE = "https://www.ilovepaghe.com";
      // Best effort: try a few pages. If CORS blocks, fallback to a public text proxy.
      const PAGES = [
        "/",
        "/index.html",
        "/come-funziona.html",
        "/dashboard.html",
        "/premium.html",
        "/dipendenti.html"
      ];

      const CACHE_KEY = "cs_site_context_v2";
      const CACHE_TTL_MS = 1000 * 60 * 60 * 12; // 12h

      // ===== DOM helpers =====
      const $ = (s, r=document) => r.querySelector(s);
      const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

      function toast(msg){
        const t = $("#toast");
        if(!t) return;
        t.textContent = msg;
        t.classList.add("show");
        clearTimeout(toast._tm);
        toast._tm = setTimeout(()=>t.classList.remove("show"), 1400);
      }

      function setLoading(on){
        const b = $("#btnGenerate");
        if(!b) return;
        b.classList.toggle("loading", !!on);
        b.disabled = !!on;
      }

      function escapeHtml(str){
        return String(str ?? "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      // ===== RNG (deterministic-ish) =====
      function hash32(str){
        let h = 2166136261 >>> 0;
        for(let i=0;i<str.length;i++){
          h ^= str.charCodeAt(i);
          h = Math.imul(h, 16777619);
        }
        return h >>> 0;
      }
      function mulberry32(seed){
        let a = seed >>> 0;
        return function(){
          a |= 0;
          a = (a + 0x6D2B79F5) | 0;
          let t = Math.imul(a ^ (a >>> 15), 1 | a);
          t = (t + Math.imul(t ^ (t >>> 7), 61 | t)) ^ t;
          return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
        };
      }
      function pick(arr, rng){ return arr[Math.floor(rng()*arr.length)] || ""; }
      function pickN(arr, n, rng){
        const a = arr.slice();
        const out = [];
        for(let i=0;i<Math.min(n,a.length);i++){
          out.push(a.splice(Math.floor(rng()*a.length),1)[0]);
        }
        return out;
      }

      // ===== Site context fetch =====
      function setCtxStatus(text, kind){
        const el = $("#ctxStatus");
        if(!el) return;
        el.textContent = text;
        el.classList.remove("good","warn");
        if(kind) el.classList.add(kind);
      }

      function cleanText(s){
        return (s || "")
          .replace(/\u00a0/g, " ")
          .replace(/[ \t]+/g, " ")
          .replace(/\n{3,}/g, "\n\n")
          .trim();
      }

      function extractTextFromHtml(html){
        try{
          const doc = new DOMParser().parseFromString(html, "text/html");
          // remove noisy nodes
          doc.querySelectorAll("script,style,noscript,svg,video,iframe,canvas").forEach(n => n.remove());
          // optionally remove nav/footer if present
          doc.querySelectorAll("nav,footer,header").forEach(n => n.remove());
          const text = doc.body ? doc.body.innerText : "";
          return cleanText(text);
        }catch(_e){
          return cleanText(html);
        }
      }

      async function fetchWithTimeout(url, ms){
        const c = new AbortController();
        const t = setTimeout(()=>c.abort(), ms);
        try{
          const res = await fetch(url, { signal:c.signal, credentials:"omit", cache:"no-store" });
          return res;
        }finally{
          clearTimeout(t);
        }
      }

      async function fetchPageTextDirect(url){
        const res = await fetchWithTimeout(url, 8000);
        if(!res.ok) throw new Error("HTTP " + res.status);
        const ct = (res.headers.get("content-type") || "").toLowerCase();
        const raw = await res.text();
        if(ct.includes("text/html") || raw.includes("<html") || raw.includes("<body")){
          return extractTextFromHtml(raw);
        }
        return cleanText(raw);
      }

      async function fetchPageTextProxy(url){
        // Public text proxy (best-effort). Remove later when backend proxy is ready.
        // Format: https://r.jina.ai/https://example.com/path
        const proxy = "https://r.jina.ai/" + url;
        const res = await fetchWithTimeout(proxy, 12000);
        if(!res.ok) throw new Error("PROXY HTTP " + res.status);
        const raw = await res.text();
        // Proxy often returns text already; keep it lean
        return cleanText(raw);
      }

      function compressContext(text){
        const max = 12000;
        if(!text) return "";
        // keep first chunk + some tail for variety
        if(text.length <= max) return text;
        const head = text.slice(0, 9000);
        const tail = text.slice(-2500);
        return cleanText(head + "\n\n" + tail);
      }

      async function buildSiteContext(force){
        // cache
        try{
          const cached = JSON.parse(localStorage.getItem(CACHE_KEY) || "null");
          if(!force && cached && cached.ts && (Date.now() - cached.ts) < CACHE_TTL_MS && cached.text){
            setCtxStatus("Contesto: caricato (cache)", "good");
            return cached.text;
          }
        }catch(_e){}

        setCtxStatus("Contesto: lettura ilovepaghe.comâ€¦", "warn");

        const urls = PAGES.map(p => SITE_BASE + p);
        const texts = [];

        // Try direct (may be blocked by CORS if this page is not on same origin)
        let directOk = false;
        for(const u of urls){
          try{
            const t = await fetchPageTextDirect(u);
            if(t) texts.push(t);
            directOk = true;
          }catch(_e){ /* ignore */ }
        }

        // Fallback proxy if direct failed or returned too little
        if(!directOk || texts.join("\n").length < 1500){
          const proxyTexts = [];
          for(const u of urls){
            try{
              const t = await fetchPageTextProxy(u);
              if(t) proxyTexts.push(t);
            }catch(_e){ /* ignore */ }
          }
          if(proxyTexts.length) texts.splice(0, texts.length, ...proxyTexts);
        }

        const merged = compressContext(texts.join("\n\n---\n\n"));
        if(!merged || merged.length < 600){
          setCtxStatus("Contesto: non disponibile (CORS/lettura bloccata)", "warn");
          // still save empty to avoid loops
          try{ localStorage.setItem(CACHE_KEY, JSON.stringify({ ts: Date.now(), text:"" })); }catch(_e){}
          return "";
        }

        setCtxStatus("Contesto: caricato (sito)", "good");
        try{ localStorage.setItem(CACHE_KEY, JSON.stringify({ ts: Date.now(), text: merged })); }catch(_e){}
        return merged;
      }

      // ===== Context â†’ signals =====
      const IT_STOP = new Set([
        "il","lo","la","i","gli","le","un","una","uno","di","a","da","in","con","su","per","tra","fra",
        "che","e","o","ma","se","non","piu","piÃ¹","come","del","della","dei","delle","al","allo","alla","ai","agli","alle",
        "nel","nello","nella","nei","nelle","sul","sullo","sulla","sui","sulle","alla","all","un","una","sono","sei","si","no",
        "questa","questo","quello","quella","anche","solo","tutto","tutta","tutti","tutte","ogni","oggi","sempre","mai",
        "puoi","puÃ²","fare","fai","fatto","piÃ¹","meno","molto","molti","molte","cosÃ¬","qui","lÃ¬","loro","noi","voi","tu","io"
      ]);

      function tokenize(text){
        return (text || "")
          .toLowerCase()
          .replace(/[^\p{L}\p{N}\s]+/gu, " ")
          .split(/\s+/)
          .map(w => w.trim())
          .filter(w => w.length >= 3 && !IT_STOP.has(w));
      }

      function topKeywords(text, limit){
        const freq = new Map();
        for(const w of tokenize(text)){
          freq.set(w, (freq.get(w) || 0) + 1);
        }
        return Array.from(freq.entries())
          .sort((a,b)=> b[1]-a[1])
          .slice(0, limit || 18)
          .map(([w])=> w);
      }

      function detectFeatures(text){
        const t = (text || "").toLowerCase();
        return {
          payroll: /cedolin|buste\s+paga|paghe|retribuz/i.test(t),
          pdf: /\bpdf\b/.test(t),
          email: /email|mail/.test(t),
          dipendenti: /dipendent/i.test(t),
          sicurezza: /privacy|sicurez|gdpr|dati/i.test(t),
          premium: /premium|abbonament|piano/i.test(t),
          demo: /demo|contatt|prenot|richied/i.test(t),
          automazione: /automat|flusso|process/i.test(t),
          dashboard: /dashboard|pannello|area\s+riservata/i.test(t),
        };
      }

      // ===== Generators (2 modes only) =====
      function makeHashtags(keywords){
        const niche = keywords.slice(0, 8);
        const mid = ["business","produttivita","processi","organizzazione","hr","aziende","lavoro","workflow"];
        const broad = ["marketing","reelsitalia","instagramtips","socialmedia","contentcreator","branding","howto","startup"];

        const all = [
          ...niche,
          ...pickN(mid, 7, mulberry32(hash32(keywords.join("|")+"mid"))),
          ...pickN(broad, 7, mulberry32(hash32(keywords.join("|")+"broad"))),
        ]
          .map(w => "#" + w.replace(/[^a-z0-9_Ã Ã¨Ã©Ã¬Ã²Ã¹]+/gi,"").slice(0, 28))
          .filter(x => x.length > 2)
          .slice(0, 22);

        return all.join(" ");
      }

      function buildGeneralPost(ctx, brief, rng){
        const kw = ctx.keywords;
        const f = ctx.features;

        const angles = [
          "errore comune",
          "checklist rapida",
          "metodo in 3 step",
          "mito vs realtÃ ",
          "prima/dopo (ordine vs caos)"
        ];

        const angle = pick(angles, rng);
        const topic = brief || (f.payroll ? "gestione e invio cedolini" : "organizzazione del lavoro");
        const benefit = f.automazione ? "meno tempo perso e meno errori" : "piÃ¹ ordine e piÃ¹ controllo";
        const proof = f.sicurezza ? "con attenzione a privacy e dati" : "senza complicare i flussi";

        const hooks = [
          `Se ${topic} ti porta via tempo, probabilmente stai sbagliando una cosa.`,
          `Lâ€™${angle} che ti fa migliorare ${topic} giÃ  da oggi.`,
          `Da caos a ordine: il modo piÃ¹ pulito per gestire ${topic}.`
        ];

        const body = [
          hooks[0],
          "",
          `ðŸ‘‰ Focus: ${angle}.`,
          "",
          `Ecco uno schema semplice:`,
          `1) Definisci lâ€™esito (cosa deve essere vero a fine flusso).`,
          `2) Riduci i passaggi: tieni solo ciÃ² che cambia il risultato.`,
          `3) Aggiungi una â€œprovaâ€ (numero, esempio, screenshot) per rendere tutto replicabile.`,
          "",
          `Risultato: ${benefit}, ${proof}.`,
          "",
          (f.demo ? `Se vuoi, richiedi una demo.` : `Se ti va, scrivimi e ti mando lo schema completo.`)
        ].join("\n");

        const hashtags = makeHashtags(kw);

        return {
          blocks: [
            { title:"Hook (3 opzioni)", text: hooks.join("\n") },
            { title:"Caption pronta", text: body },
            { title:"Hashtag", text: hashtags }
          ],
          copyAll: ["HOOK:\n"+hooks.join("\n"), "\nCAPTION:\n"+body, "\nHASHTAG:\n"+hashtags].join("\n\n")
        };
      }

      function buildGeneralReel(ctx, brief, rng){
        const kw = ctx.keywords;
        const f = ctx.features;

        const topic = brief || (f.payroll ? "invio cedolini senza confusione" : "mettere ordine nel processo");
        const benefit = f.automazione ? "tagli tempo e riduci errori" : "risparmi tempo e lavori piÃ¹ pulito";
        const proof = f.sicurezza ? "senza perdere controllo su privacy e dati" : "senza passaggi inutili";

        const hookOpts = [
          `Se ${topic} Ã¨ sempre un casino, guarda questo.`,
          `3 step per ${topic} (senza complicarti la vita).`,
          `Il dettaglio che ti fa ${benefit} in modo stabile.`
        ];

        const hook = hookOpts[0];

        const onScreen = [
          `Basta caos su ${topic}`,
          `Framework: Hook â†’ Valore â†’ Prova â†’ CTA`,
          `Step 1: esito finale`,
          `Step 2: togli rumore`,
          `Step 3: aggiungi una prova`,
          `Risultato: ${benefit}`,
          f.demo ? `CTA: richiedi demo` : `CTA: scrivimi`
        ].join("\n");

        const voice = [
          `[0â€“2s] ${hook}`,
          `[2â€“7s] Se vuoi ${benefit}, ti serve un processo ripetibile, non â€œpiÃ¹ faticaâ€.`,
          `[7â€“16s] Fai cosÃ¬: 1) definisci lâ€™esito, 2) riduci i passaggi, 3) aggiungi una prova (numero o esempio).`,
          `[16â€“24s] Questo ti dÃ  ${benefit}, ${proof}.`,
          `[24â€“30s] Salva questo reel. ${f.demo ? "Se vuoi, richiedi una demo." : "Se ti serve, scrivimi."}`
        ].join("\n");

        const shotlist = [
          `1) Hook â€” primo piano / testo grande: â€œ${hook}â€`,
          `2) Problema â€” b-roll scrivania / schermo: â€œTroppi passaggi = erroriâ€`,
          `3) Framework â€” overlay: â€œHook â†’ Valore â†’ Prova â†’ CTAâ€`,
          `4) Step â€” 3 bullet a schermo (veloci, leggibili)`,
          `5) Risultato â€” testo: â€œ${benefit}â€`,
          `6) CTA â€” end card: â€œSalva â€¢ ${f.demo ? "Richiedi demo" : "Scrivimi"}â€`
        ].join("\n");

        const caption = [
          hook,
          "",
          `Schema rapido per ${topic}:`,
          `â€¢ Esito finale chiaro`,
          `â€¢ Passaggi essenziali`,
          `â€¢ Una prova concreta (numero/esempio)`,
          "",
          `Risultato: ${benefit}.`,
          "",
          (f.demo ? `Vuoi vedere come si applica su iLovePaghe? Richiedi una demo.` : `Se ti va, scrivimi e ti mando la checklist.`)
        ].join("\n");

        const hashtags = makeHashtags(kw);

        return {
          blocks: [
            { title:"Hook (3 opzioni)", text: hookOpts.join("\n") },
            { title:"On-screen text", text: onScreen },
            { title:"Voiceover", text: voice, mono:true },
            { title:"Shotlist", text: shotlist },
            { title:"Caption pronta", text: caption },
            { title:"Hashtag", text: hashtags }
          ],
          copyAll: [
            "HOOK (3 opzioni):\n"+hookOpts.join("\n"),
            "\nON-SCREEN:\n"+onScreen,
            "\nVOICEOVER:\n"+voice,
            "\nSHOTLIST:\n"+shotlist,
            "\nCAPTION:\n"+caption,
            "\nHASHTAG:\n"+hashtags
          ].join("\n\n")
        };
      }

      // ===== UI render =====
      let mode = "post";
      let siteText = "";
      let lastOutput = { copyAll:"", blocks:[] };

      function renderBlocks(out){
        const area = $("#outArea");
        if(!area) return;
        area.innerHTML = out.blocks.map((b, idx) => `
          <div class="block">
            <div class="blockHead">
              <div class="blockTitle">${escapeHtml(b.title)}</div>
              <button class="mini" type="button" data-copy="${idx}">Copia</button>
            </div>
            <div class="blockBody">
              <div class="pre ${b.mono ? "mono" : ""}">${escapeHtml(b.text || "â€”")}</div>
            </div>
          </div>
        `).join("");

        $$("button[data-copy]").forEach(btn => {
          btn.addEventListener("click", async () => {
            const i = parseInt(btn.getAttribute("data-copy") || "0", 10);
            const text = out.blocks[i]?.text || "";
            const ok = await copy(text);
            toast(ok ? "Copiato" : "Impossibile copiare");
          });
        });
      }

      async function copy(text){
        const t = String(text || "").trim();
        if(!t) return false;
        try{
          await navigator.clipboard.writeText(t);
          return true;
        }catch(_e){
          try{
            const ta = document.createElement("textarea");
            ta.value = t;
            ta.style.position = "fixed";
            ta.style.opacity = "0";
            document.body.appendChild(ta);
            ta.select();
            document.execCommand("copy");
            document.body.removeChild(ta);
            return true;
          }catch(_e2){
            return false;
          }
        }
      }

      function setMode(next){
        mode = (next === "reel") ? "reel" : "post";
        $("#modePost").classList.toggle("active", mode === "post");
        $("#modeReel").classList.toggle("active", mode === "reel");
        $("#modePost").setAttribute("aria-selected", mode === "post" ? "true" : "false");
        $("#modeReel").setAttribute("aria-selected", mode === "reel" ? "true" : "false");

        // If we already have output, regenerate lightly (optional) â€” we keep simple: do nothing.
      }

      function buildCtxSignals(siteText){
        const keywords = topKeywords(siteText, 18);
        const features = detectFeatures(siteText);
        // If site text is empty, inject safe defaults
        const safeKw = keywords.length ? keywords : ["ilovepaghe","cedolini","paghe","hr","aziende","pdf","email","dashboard","privacy"];
        return { keywords: safeKw, features };
      }

      async function onGenerate(){
        const brief = ($("#brief")?.value || "").trim();
        $("#hint").style.display = "none";

        setLoading(true);
        try{
          // Ensure context
          if(!siteText){
            siteText = await buildSiteContext(false);
          }
          if(!siteText){
            // still allow generation with default context, but warn
            setCtxStatus("Contesto: limitato (impossibile leggere il sito)", "warn");
          }

          const ctx = buildCtxSignals(siteText || "");
          const seedStr = (mode + "|" + (brief || "") + "|" + ctx.keywords.join(","));
          const rng = mulberry32(hash32(seedStr) ^ Date.now()); // fresh each click

          lastOutput = (mode === "reel")
            ? buildGeneralReel(ctx, brief, rng)
            : buildGeneralPost(ctx, brief, rng);

          renderBlocks(lastOutput);
          toast("Generato");
        }finally{
          setLoading(false);
        }
      }

      async function init(){
        // Bind
        $("#modePost").addEventListener("click", () => setMode("post"));
        $("#modeReel").addEventListener("click", () => setMode("reel"));

        $("#btnGenerate").addEventListener("click", onGenerate);

        $("#btnCopyAll").addEventListener("click", async () => {
          const ok = await copy(lastOutput.copyAll || "");
          toast(ok ? "Copiato tutto" : "Impossibile copiare");
        });

        // Load context in background (no button)
        try{
          siteText = await buildSiteContext(false);
        }catch(_e){
          // ignore
        }

        // First render placeholder blocks
        lastOutput = {
          blocks: [
            { title: "Output", text: "Scrivi unâ€™idea (opzionale) e clicca Genera." }
          ],
          copyAll: ""
        };
        renderBlocks(lastOutput);
      }

      if(document.readyState === "loading"){
        document.addEventListener("DOMContentLoaded", init);
      }else{
        init();
      }
    })();
  </script>
</body>
</html>
