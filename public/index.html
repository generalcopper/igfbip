<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#1c6fe6" />
  <title>Content Studio | iLovePaghe</title>
  <meta name="robots" content="noindex,nofollow" />

  <style>
    :root{
      --bg:#f6f7f8;
      --card:#ffffff;
      --stroke:rgba(15,23,42,.10);
      --text:rgba(15,23,42,.92);
      --muted:rgba(15,23,42,.62);
      --accent:#1c6fe6;
      --accent-soft:rgba(28,111,230,.10);
      --shadow:0 16px 44px rgba(15,23,42,.06);
      --r-lg:22px;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bot: env(safe-area-inset-bottom, 0px);
      --focus:0 0 0 3px rgba(28,111,230,.18),0 0 0 6px rgba(28,111,230,.08);
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    html,body{
      margin:0;
      min-height:100%;
      font-family: ui-sans-serif,system-ui,"Segoe UI",Roboto,"Helvetica Neue",Helvetica,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
      letter-spacing:-0.01em;
      line-height:1.55;
    }
    :focus-visible{ outline:none; box-shadow:var(--focus); border-radius:12px; }

    .wrap{
      width:100%;
      max-width:1100px;
      margin:0 auto;
      padding:calc(20px + var(--safe-top)) clamp(16px,4vw,34px) calc(80px + var(--safe-bot));
      display:grid;
      gap:14px;
    }

    .top{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:var(--r-lg);
      box-shadow:var(--shadow);
      padding:14px 14px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px 12px;
      flex-wrap:wrap;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .brandLogo{
      height:26px;
      width:auto;
      display:block;
    }
    .brandText{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .brandText h1{
      margin:0;
      font-size:14px;
      font-weight:750;
      letter-spacing:-0.02em;
      white-space:nowrap;
    }
    .brandText p{
      margin:0;
      font-size:12px;
      font-weight:560;
      color:var(--muted);
      max-width:min(68ch, 90vw);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .mode{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .pill{
      border:1px solid rgba(15,23,42,.12);
      background:rgba(15,23,42,.03);
      border-radius:999px;
      padding:8px 12px;
      font-size:12px;
      font-weight:750;
      color:rgba(15,23,42,.70);
      cursor:pointer;
      user-select:none;
      transition:transform .16s cubic-bezier(.22,.61,.36,1), background .14s ease, border-color .14s ease;
      white-space:nowrap;
    }
    .pill:active{ transform:translateY(1px) scale(.99); }
    .pill.active{
      background:var(--accent-soft);
      border-color:rgba(28,111,230,.22);
      color:rgba(18,74,164,.94);
    }

    .actions{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end; flex:1 1 auto; }
    .btn{
      border:1px solid rgba(15,23,42,.14);
      background:#fff;
      border-radius:14px;
      padding:10px 12px;
      font-size:13px;
      font-weight:750;
      color:rgba(15,23,42,.90);
      cursor:pointer;
      user-select:none;
      min-height:40px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition:transform .16s cubic-bezier(.22,.61,.36,1), opacity .14s ease;
      white-space:nowrap;
    }
    .btn:active{ transform:translateY(1px) scale(.99); opacity:.92; }
    .btn.primary{ background:var(--accent); border-color:var(--accent); color:#fff; }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

    .spinner{
      width:14px; height:14px; border-radius:999px;
      border:2px solid rgba(255,255,255,.45); border-top-color:#fff;
      display:none; animation:spin .9s linear infinite;
    }
    .btn.loading .spinner{ display:inline-block; }
    @keyframes spin{ to{ transform:rotate(360deg);} }

    .card{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:var(--r-lg);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(15,23,42,.06);
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:10px;
      flex-wrap:wrap;
    }
    .cardHead .h{ font-size:14px; font-weight:750; margin:0; }

    .status{
      font-size:12px;
      font-weight:650;
      color:rgba(15,23,42,.58);
      padding:6px 10px;
      border:1px solid rgba(15,23,42,.10);
      background:rgba(15,23,42,.03);
      border-radius:999px;
      white-space:nowrap;
    }
    .status.good{ background:rgba(52,199,89,.12); border-color:rgba(52,199,89,.18); color:rgba(24,140,70,.92); }
    .status.warn{ background:rgba(255,159,10,.14); border-color:rgba(255,159,10,.18); color:rgba(155,96,0,.94); }
    .status.bad{ background:rgba(255,59,48,.12); border-color:rgba(255,59,48,.18); color:rgba(160,30,24,.94); }

    .grid{
      display:grid;
      grid-template-columns:1fr;
      gap:14px;
      padding:14px;
    }
    @media (min-width: 920px){
      .grid{ grid-template-columns: .95fr 1.05fr; }
    }

    .field{ display:grid; gap:8px; }
    .label{ font-size:12px; font-weight:750; color:rgba(15,23,42,.70); }
    .textarea{
      width:100%;
      border:1px solid rgba(15,23,42,.12);
      border-radius:14px;
      background:#fff;
      padding:10px 12px;
      font-size:13px;
      font-weight:560;
      color:rgba(15,23,42,.86);
      outline:none;
      min-height:120px;
      resize:vertical;
    }
    .textarea::placeholder{ color:rgba(15,23,42,.45); }
    .textarea:focus{ border-color:rgba(28,111,230,.35); box-shadow:var(--focus); }
    .note{ font-size:12px; font-weight:560; color:rgba(15,23,42,.58); }
    .note strong{ font-weight:750; }

    .out{ display:grid; gap:12px; }

    .panel{
      border:1px solid rgba(15,23,42,.10);
      border-radius:18px;
      overflow:hidden;
      background:#fff;
    }
    .panelHead{
      padding:10px 12px;
      border-bottom:1px solid rgba(15,23,42,.06);
      background:rgba(15,23,42,.02);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .panelTitle{
      font-size:12px;
      font-weight:850;
      letter-spacing:.02em;
      color:rgba(15,23,42,.70);
      text-transform:uppercase;
    }
    .panelBody{ padding:10px 12px 12px; }
    .pre{ white-space:pre-wrap; font-size:13px; font-weight:560; color:rgba(15,23,42,.82); line-height:1.5; }

    .skeleton{
      width:100%;
      height:220px;
      border-radius:14px;
      border:1px solid rgba(15,23,42,.08);
      background:linear-gradient(90deg, rgba(15,23,42,.04), rgba(15,23,42,.08), rgba(15,23,42,.04));
      background-size:200% 100%;
      animation:shimmer 1.2s ease-in-out infinite;
    }
    @keyframes shimmer{
      0%{ background-position:200% 0; }
      100%{ background-position:-200% 0; }
    }

    .carouselGrid{ display:grid; gap:10px; }
    .slide{
      border:1px solid rgba(15,23,42,.08);
      border-radius:14px;
      overflow:hidden;
      background:#fff;
    }
    .slide img, .slide video{
      width:100%;
      display:block;
      background:#fff;
    }
    .slideMeta{
      padding:8px 10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      border-top:1px solid rgba(15,23,42,.06);
      background:rgba(15,23,42,.02);
    }
    .slideLabel{ font-size:12px; font-weight:650; color:rgba(15,23,42,.62); }
    .slideHint{ font-size:12px; font-weight:650; color:rgba(15,23,42,.50); white-space:nowrap; }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:rgba(15,23,42,.92);
      color:#fff;
      padding:10px 12px;
      border-radius:14px;
      font-size:13px;
      font-weight:650;
      opacity:0;
      pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(-2px); }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top" role="banner">
      <div class="brand">
        <img class="brandLogo" src="https://www.ilovepaghe.com/ilovepaghe_logobluvsblack.png" alt="iLovePaghe" onerror="this.style.display='none'" />
        <div class="brandText">
          <h1>Content Studio</h1>
          <p>Post → Carosello serio • Reel → cover + video</p>
        </div>
      </div>

      <div class="mode" role="tablist" aria-label="Modalità">
        <button class="pill active" id="modePost" type="button" role="tab" aria-selected="true">General Post</button>
        <button class="pill" id="modeReel" type="button" role="tab" aria-selected="false">General Reel</button>
      </div>

      <div class="actions">
        <button class="btn primary" id="btnGenerate" type="button">
          <span class="spinner" aria-hidden="true"></span>
          <span>Genera</span>
        </button>
        <button class="btn" id="btnCopyAll" type="button">Copia tutto</button>
      </div>
    </div>

    <div class="card">
      <div class="cardHead">
        <h2 class="h">Brief</h2>
        <span class="status warn" id="apiStatus">API: collegamento…</span>
      </div>

      <div class="grid">
        <div class="field">
          <div class="label">Idea / angolo (opzionale)</div>
          <textarea id="brief" class="textarea" placeholder="Esempi:&#10;• Demo iLovePaghe: come funziona in 30 secondi&#10;• Da PDF unico a invii singoli senza errori&#10;• Privacy e controllo: invio cedolini in modo ordinato"></textarea>
          <div class="note">Per includere il logo nelle slide: scrivi <strong>con logo</strong> nel brief.</div>
        </div>

        <div class="out">
          <div class="panel">
            <div class="panelHead"><div class="panelTitle" id="textTitle">Caption</div></div>
            <div class="panelBody">
              <div class="pre" id="textOut">Scrivi un’idea (opzionale) e clicca Genera.</div>
            </div>
          </div>

          <div class="panel">
            <div class="panelHead"><div class="panelTitle">Media</div></div>
            <div class="panelBody">
              <div id="mediaOut" class="pre">Qui compariranno le slide del carosello (Post) o cover+video (Reel).</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script>
    (function(){
      "use strict";

      const API_BASE = (window.CONTENT_API_BASE || "https://ilp-content-gen-108182410176.europe-west1.run.app").replace(/\/+$/, "");
      const EP_HEALTH = "/health";
      const EP_CONTENT = "/api/content/generate";
      const EP_IMAGE = "/api/image/generate";
      const EP_VIDEO = "/api/video/generate";
      const EP_CAROUSEL = "/api/carousel/generate";

      const $ = (s, r=document) => r.querySelector(s);

      let mode = "post";
      let copyAllText = "";
      let lastVideoObjectUrl = null;

      function toast(msg){
        const t = $("#toast");
        if(!t) return;
        t.textContent = msg;
        t.classList.add("show");
        clearTimeout(toast._tm);
        toast._tm = setTimeout(()=>t.classList.remove("show"), 1400);
      }

      function setLoading(on){
        const b = $("#btnGenerate");
        if(!b) return;
        b.classList.toggle("loading", !!on);
        b.disabled = !!on;
      }

      function setApiStatus(text, kind){
        const el = $("#apiStatus");
        if(!el) return;
        el.textContent = text;
        el.classList.remove("good","warn","bad");
        if(kind) el.classList.add(kind);
      }

      async function copy(text){
        const t = String(text || "").trim();
        if(!t) return false;
        try{
          await navigator.clipboard.writeText(t);
          return true;
        }catch(_e){
          try{
            const ta = document.createElement("textarea");
            ta.value = t;
            ta.style.position = "fixed";
            ta.style.opacity = "0";
            document.body.appendChild(ta);
            ta.select();
            document.execCommand("copy");
            document.body.removeChild(ta);
            return true;
          }catch(_e2){
            return false;
          }
        }
      }

      async function fetchJSON(url, opts){
        const controller = new AbortController();
        const t = setTimeout(()=>controller.abort(), 180000);
        try{
          const r = await fetch(url, { ...opts, signal: controller.signal });
          const txt = await r.text();
          let data = null;
          try{ data = JSON.parse(txt); } catch(_e){ data = { raw: txt }; }
          if(!r.ok){
            const msg = data?.message || data?.error || ("HTTP " + r.status);
            const err = new Error(msg);
            err.status = r.status;
            err.data = data;
            throw err;
          }
          return data;
        } finally {
          clearTimeout(t);
        }
      }

      async function fetchBlob(url, opts){
        const controller = new AbortController();
        const t = setTimeout(()=>controller.abort(), 15 * 60 * 1000);
        try{
          const r = await fetch(url, { ...opts, signal: controller.signal });
          if(!r.ok){
            const txt = await r.text().catch(()=> "");
            throw new Error(txt || ("HTTP " + r.status));
          }
          return await r.blob();
        } finally {
          clearTimeout(t);
        }
      }

      function setMode(next){
        mode = (next === "reel") ? "reel" : "post";
        $("#modePost").classList.toggle("active", mode === "post");
        $("#modeReel").classList.toggle("active", mode === "reel");
        $("#modePost").setAttribute("aria-selected", mode === "post" ? "true" : "false");
        $("#modeReel").setAttribute("aria-selected", mode === "reel" ? "true" : "false");

        $("#textTitle").textContent = (mode === "post") ? "Caption" : "Testo";
      }

      async function pingHealth(){
        try{
          await fetchJSON(API_BASE + EP_HEALTH, { method:"GET" });
          setApiStatus("API: ok", "good");
        }catch(_e){
          setApiStatus("API: offline", "bad");
        }
      }

      function wantsLogo(brief){
        const b = (brief || "").toLowerCase();
        return /\bcon\s+logo\b/.test(b) || /\[logo\]/.test(b) || /#logo\b/.test(b) || /\+logo\b/.test(b);
      }

      function renderMediaLoading(label){
        const media = $("#mediaOut");
        media.innerHTML = `<div class="skeleton"></div><div class="pre" style="margin-top:8px;">${label || "In generazione…"}</div>`;
      }

      function renderCarousel(slides, size){
        const media = $("#mediaOut");
        if(!slides || !slides.length){
          media.textContent = "Nessun media generato.";
          return;
        }

        const items = slides.map((s, i) => {
          const url = "data:" + (s.mimeType || "image/png") + ";base64," + s.imageBase64;
          const label = `Slide ${i+1}/${slides.length}`;
          return `
            <div class="slide">
              <img src="${url}" alt="${label}" />
              <div class="slideMeta">
                <div class="slideLabel">${label}</div>
                <div class="slideHint">${size || "1080x1350"}</div>
              </div>
            </div>
          `;
        }).join("");

        media.innerHTML = `<div class="carouselGrid">${items}</div>`;
      }

      function renderReelMedia(coverBase64, coverMime, videoUrl){
        const media = $("#mediaOut");
        const coverUrl = coverBase64 ? ("data:" + (coverMime || "image/png") + ";base64," + coverBase64) : null;

        const parts = [];
        if(coverUrl){
          parts.push(`
            <div class="slide">
              <img src="${coverUrl}" alt="Cover Reel" />
              <div class="slideMeta"><div class="slideLabel">Cover</div><div class="slideHint">9:16</div></div>
            </div>
          `);
        }
        if(videoUrl){
          parts.push(`
            <div class="slide">
              <video controls playsinline src="${videoUrl}"></video>
              <div class="slideMeta"><div class="slideLabel">Video</div><div class="slideHint">9:16</div></div>
            </div>
          `);
        }
        media.innerHTML = `<div class="carouselGrid">${parts.join("")}</div>`;
      }

      async function onGenerate(){
        const brief = ($("#brief")?.value || "").trim();
        const includeLogo = wantsLogo(brief);

        if (lastVideoObjectUrl) {
          try { URL.revokeObjectURL(lastVideoObjectUrl); } catch(_e){}
          lastVideoObjectUrl = null;
        }

        setLoading(true);
        try{
          $("#textOut").textContent = (mode === "post") ? "Generazione caption…" : "Generazione testo…";
          $("#mediaOut").textContent = "In attesa…";

          if(mode === "post"){
            renderMediaLoading("Carosello (in generazione…)");

            const car = await fetchJSON(API_BASE + EP_CAROUSEL, {
              method: "POST",
              headers: { "content-type": "application/json" },
              body: JSON.stringify({ brief, includeLogo, size: "1080x1350" })
            });

            $("#textOut").textContent = car?.caption || "—";
            copyAllText = car?.caption || "";

            renderCarousel(car?.slides || [], car?.size || "1080x1350");

          } else {
            // Reel: testo + cover + video
            const content = await fetchJSON(API_BASE + EP_CONTENT, {
              method: "POST",
              headers: { "content-type": "application/json" },
              body: JSON.stringify({ mode: "reel", brief })
            });

            const blocks = Array.isArray(content?.blocks) ? content.blocks : [];
            const lines = [];
            for(const b of blocks){
              lines.push((b.title||"").toUpperCase());
              lines.push(b.text||"");
              lines.push("");
            }
            $("#textOut").textContent = lines.join("\n").trim();
            copyAllText = content?.copyAll || $("#textOut").textContent;

            renderMediaLoading("Cover Reel (in generazione…)");

            const img = await fetchJSON(API_BASE + EP_IMAGE, {
              method: "POST",
              headers: { "content-type": "application/json" },
              body: JSON.stringify({ mode:"reel", brief, aspectRatio: "9:16", includeLogo })
            });

            const coverBase64 = img?.imageBase64 || null;
            renderReelMedia(coverBase64, img?.mimeType, null);

            renderMediaLoading("Video Reel (in generazione…)");

            const blob = await fetchBlob(API_BASE + EP_VIDEO, {
              method: "POST",
              headers: { "content-type": "application/json" },
              body: JSON.stringify({ brief, aspectRatio:"9:16", resolution:"720p" })
            });

            const vUrl = URL.createObjectURL(blob);
            lastVideoObjectUrl = vUrl;
            renderReelMedia(coverBase64, img?.mimeType, vUrl);
          }

          toast("Generato");
          setApiStatus("API: ok", "good");

        } catch (e) {
          $("#textOut").textContent = "ERRORE\n\n" + (e?.message || "Errore");
          $("#mediaOut").innerHTML = `<div class="pre">Errore: ${(e?.message || "Errore")}</div>`;
          toast("Errore");
          setApiStatus("API: errore", "warn");
        } finally {
          setLoading(false);
        }
      }

      async function init(){
        $("#modePost").addEventListener("click", () => setMode("post"));
        $("#modeReel").addEventListener("click", () => setMode("reel"));
        $("#btnGenerate").addEventListener("click", onGenerate);

        $("#btnCopyAll").addEventListener("click", async () => {
          const ok = await copy(copyAllText || $("#textOut")?.textContent || "");
          toast(ok ? "Copiato" : "Impossibile copiare");
        });

        await pingHealth();
      }

      if(document.readyState === "loading"){
        document.addEventListener("DOMContentLoaded", init);
      }else{
        init();
      }
    })();
  </script>
</body>
</html>
